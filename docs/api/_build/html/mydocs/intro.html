

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-cn" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-cn" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fei’s django app demo INTRO / 简介 &mdash; Fei Django Demo v0.01 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="fei" href="../api/modules.html" />
    <link rel="prev" title="Welcome to Fei Django Demo’s documentation!" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Fei Django Demo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents/欢迎阅读:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fei’s django app demo INTRO / 简介</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">项目布署在这儿</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">模型扩展</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#abstractuser">继承AbstractUser并扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="#one-to-one">One-To-One方式扩展</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#vs-one-to-one">直接修改模型并迁移 vs one-to-one</a></li>
<li class="toctree-l2"><a class="reference internal" href="#middleware">自行定制middleware</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auth-backend">自行定制auth backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-root-open-api-swagger">API Root / Open API / Swagger等</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">一个表情包加文字的小功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ip">一个查询IP的小功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="#webhook">webhook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#docker">用docker来布署开发环境</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">要点</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nginx">nginx</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python3-django">python3/Django应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mysql">mysql</a></li>
<li class="toctree-l3"><a class="reference internal" href="#redis">redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq">rabbitmq</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#git-server">自建git server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">腾讯云redis的一个简单测试</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">fei</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Fei Django Demo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Fei’s django app demo INTRO / 简介</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/mydocs/intro.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fei-s-django-app-demo-intro">
<h1>Fei’s django app demo INTRO / 简介<a class="headerlink" href="#fei-s-django-app-demo-intro" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>项目布署在这儿<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p><a href="http://demo.hhxx.me">http://demo.hhxx.me</a></p>
</div>
<div class="section" id="id2">
<h2>模型扩展<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<div class="section" id="abstractuser">
<h3>继承AbstractUser并扩展<a class="headerlink" href="#abstractuser" title="永久链接至标题">¶</a></h3>
<p>对于新开发系统，可以<strong>考虑</strong>从AbstractUser继承并扩展，增加需要的字段。</p>
<p>以下是一个例子</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 以下是自建了一个用户模型，并且已经在settings中替换了

from django.contrib.auth.models import AbstractUser
from django.db import models

class CustomUser(AbstractUser):
    chinese_name = models.CharField(max_length=50, unique=True, blank=False)
    chinese_pass = models.CharField(max_length=100, blank=True)
    chinese_addr = models.CharField(max_length=200, blank=True)

# 在settings中设定了替换默认的User模型
AUTH_USER_MODEL = &#39;app_models.CustomUser&#39;

# 迁移后创建了自定义的用户表，名字是 &lt;appname_customuser&gt;
# 默认的auth_user表没有了，被此customuser表代替
# 而其它的系统表名字都不变，仍然是auth_groups /auth_permissions等
# 可以看到，customuser在User模型上，增加了上面自定义的三个字段
CREATE TABLE `app_models_customuser` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `password` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL,
  `last_login` datetime(6) DEFAULT NULL,
  `is_superuser` tinyint(1) NOT NULL,
  `username` varchar(150) COLLATE utf8mb4_unicode_ci NOT NULL,
  `first_name` varchar(30) COLLATE utf8mb4_unicode_ci NOT NULL,
  `last_name` varchar(150) COLLATE utf8mb4_unicode_ci NOT NULL,
  `email` varchar(254) COLLATE utf8mb4_unicode_ci NOT NULL,
  `is_staff` tinyint(1) NOT NULL,
  `is_active` tinyint(1) NOT NULL,
  `date_joined` datetime(6) NOT NULL,
  `chinese_name` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL,
  `chinese_pass` varchar(100) COLLATE utf8mb4_unicode_ci NOT NULL,
  `chinese_addr` varchar(200) COLLATE utf8mb4_unicode_ci NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  UNIQUE KEY `chinese_name` (`chinese_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci

# 看一下user permissions表，本来默认指向 auth_user的外键，现在指向了这个customuser表；
# 本来指向auth_permission的外键，依然不变

CREATE TABLE `app_models_customuser_user_permissions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `customuser_id` int(11) NOT NULL,
  `permission_id` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `app_models_customuser_us_customuser_id_permission_b33a0c84_uniq` (`customuser_id`,`permission_id`),
  KEY `app_models_customuse_permission_id_948a0a60_fk_auth_perm` (`permission_id`),
  CONSTRAINT `app_models_customuse_customuser_id_50275884_fk_app_model` FOREIGN KEY (`customuser_id`) REFERENCES `app_models_customuser` (`id`),
  CONSTRAINT `app_models_customuse_permission_id_948a0a60_fk_auth_perm` FOREIGN KEY (`permission_id`) REFERENCES `auth_permission` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
</pre></div>
</div>
<p>因此，从AbstractUser扩展，实际上就是把默认的auth_user，替换成了自定义的CustomerUser。</p>
<p>以上CustomUser模型在后续可以修改定义，增减字段，然后执行迁移，也是很方便的。</p>
</div>
<div class="section" id="one-to-one">
<h3>One-To-One方式扩展<a class="headerlink" href="#one-to-one" title="永久链接至标题">¶</a></h3>
<p>在已有的系统增加，则可以考虑通过one to one的关系，增加一个额外的模型；</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>既可以使用django的auth backend，也可以扩展使用自定义的认证方式，例如使用多个标识（用户名/邮箱/手机呈等）登录。
</pre></div>
</div>
</div>
</div>
<div class="section" id="vs-one-to-one">
<h2>直接修改模型并迁移 vs one-to-one<a class="headerlink" href="#vs-one-to-one" title="永久链接至标题">¶</a></h2>
<p>直接修改模型保证新加的字段和原字段在同一张表里，每个用户进来的时候一次就获取到需要数据；</p>
<p>one-to-one意味着每个用户进来的时候，需要访问两张表才获取到全部数据，性能当然会降低，对系统压力更大一点；</p>
<p>不过，如果额外增加的信息是一个很少用到的信息，用one-to-one，能减少访问表的次数，对性能反而是有益的。</p>
</div>
<div class="section" id="middleware">
<h2>自行定制middleware<a class="headerlink" href="#middleware" title="永久链接至标题">¶</a></h2>
<p>针对全部用户或针对全部访问请求的操作，可以用定制middleware实现</p>
<p>见<code class="docutils literal notranslate"><span class="pre">fei/fei_middlewares</span></code>目录：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 为用户初始化一些信息</span>
<span class="n">data_initial</span><span class="o">.</span><span class="n">py</span>
    <span class="n">initial_user_asset</span>
    <span class="n">initial_user_extra</span>

<span class="c1"># 为用户自动生成token</span>
<span class="n">generate_token</span><span class="o">.</span><span class="n">py</span>
    <span class="n">generate_token_if_not_exist</span>

<span class="c1"># 开放了一个测试用户，为了避免被改密码，简单的禁止了该用户的改密码功能</span>
<span class="c1"># 其实只是禁止了change password的url</span>
<span class="n">user_filter</span><span class="o">.</span><span class="n">py</span>
    <span class="n">disable_user_change_pass</span>

<span class="c1"># 以下几个middlewares作为调试工具，可以在控制台打印出当前访问用户、headers、用户token等信息</span>
<span class="n">headers_info</span><span class="o">.</span><span class="n">py</span>
    <span class="n">request_headers</span>
    <span class="n">response_headers</span>
<span class="n">logging_user</span><span class="o">.</span><span class="n">py</span>
    <span class="n">django_current_user</span>
<span class="n">drf_token_info</span><span class="o">.</span><span class="n">py</span>
    <span class="n">drf_user_info</span>
</pre></div>
</div>
</div>
<div class="section" id="auth-backend">
<h2>自行定制auth backend<a class="headerlink" href="#auth-backend" title="永久链接至标题">¶</a></h2>
<p>通过定制的backend，实现username, email，手机号，或者任何其它需要的用户标识来进行认证；</p>
<p>并且用户可以用password或pay_password等任何密码来进行认证。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fei</span><span class="o">/</span><span class="n">fei_backends</span><span class="o">/</span><span class="n">fei_auth</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</div>
<div class="section" id="api-root-open-api-swagger">
<h2>API Root / Open API / Swagger等<a class="headerlink" href="#api-root-open-api-swagger" title="永久链接至标题">¶</a></h2>
<p>写了一个简单的后端demo</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">demo</span><span class="o">.</span><span class="n">hhxx</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span>									<span class="c1"># Api Root</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">demo</span><span class="o">.</span><span class="n">hhxx</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">drf</span><span class="o">/</span><span class="n">openapi</span><span class="o">/</span>				<span class="c1"># Open API</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">demo</span><span class="o">.</span><span class="n">hhxx</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">drf</span><span class="o">/</span><span class="n">swargger</span><span class="o">/</span>				<span class="c1"># 用swagger UI格式的接口列表</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>一个表情包加文字的小功能<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">demo</span><span class="o">.</span><span class="n">hhxx</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="n">emoji</span><span class="o">/</span>					<span class="c1"># 一个表情包处理的功能，做给朋友玩</span>
																				<span class="c1"># fei/app_img</span>
</pre></div>
</div>
</div>
<div class="section" id="ip">
<h2>一个查询IP的小功能<a class="headerlink" href="#ip" title="永久链接至标题">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">demo</span><span class="o">.</span><span class="n">hhxx</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">ip</span><span class="o">/</span>									<span class="c1"># 发现查询自已的公网ip的功能还比较常用，然后一些查ip的网站老是给一个页面出来，所以做个小功能，直接返回个json就可以了，便于命令行curl访问。用法：</span>

<span class="n">curl</span> <span class="n">demo</span><span class="o">.</span><span class="n">hhxx</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">ip</span><span class="o">/</span>										<span class="c1"># output: {&quot;Your IP&quot;: &quot;61.140.26.251&quot;}</span>
</pre></div>
</div>
</div>
<div class="section" id="webhook">
<h2>webhook<a class="headerlink" href="#webhook" title="永久链接至标题">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 收到webhook后，在本地就去git pull一下相应的repo</span>
<span class="c1"># 用于在ecs上自动更新代码</span>
<span class="c1"># 没想好需要些什么功能，目前就最简单粗暴的git pull一下</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fei</span><span class="o">-</span><span class="n">webhook</span><span class="o">.</span><span class="n">readthedocs</span><span class="o">.</span><span class="n">io</span><span class="o">/</span>						<span class="c1"># webhook的文档</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">colingong</span><span class="o">/</span><span class="n">fei_webhook</span><span class="o">/</span>			<span class="c1"># 项目代码</span>
</pre></div>
</div>
</div>
<div class="section" id="docker">
<h2>用docker来布署开发环境<a class="headerlink" href="#docker" title="永久链接至标题">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 腾讯云 ecs: 1CPU/1GB Ram/40GB HDD</span>
<span class="c1"># 本机布署以下应用/组件</span>

<span class="n">python</span><span class="p">:</span><span class="mf">3.6</span><span class="n">ays</span>           <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8001</span><span class="o">-&gt;</span><span class="mi">8000</span><span class="o">/</span><span class="n">tcp</span>                               <span class="mi">8001</span><span class="n">dj_webhook</span>
<span class="n">python</span><span class="p">:</span><span class="mf">3.6</span><span class="n">inutes</span>        <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5553</span><span class="o">-&gt;</span><span class="mi">5556</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">83</span><span class="o">-&gt;</span><span class="mi">8000</span><span class="o">/</span><span class="n">tcp</span>         <span class="mi">83</span><span class="n">dj_fei</span>
<span class="n">python</span><span class="p">:</span><span class="mf">3.6</span><span class="n">eeks</span>          <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5557</span><span class="o">-&gt;</span><span class="mi">5556</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">81</span><span class="o">-&gt;</span><span class="mi">8000</span><span class="o">/</span><span class="n">tcp</span>         <span class="mi">81</span><span class="n">dj_weixin</span>
<span class="n">python</span><span class="p">:</span><span class="mf">3.6</span><span class="n">eeks</span>          <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5556</span><span class="o">-&gt;</span><span class="mi">5556</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">82</span><span class="o">-&gt;</span><span class="mi">8000</span><span class="o">/</span><span class="n">tcp</span>         <span class="mi">82</span><span class="n">dj_educa</span>
<span class="n">nginx</span><span class="p">:</span><span class="mf">1.14</span><span class="n">days</span>          <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span><span class="o">-&gt;</span><span class="mi">80</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">443</span><span class="o">-&gt;</span><span class="mi">443</span><span class="o">/</span><span class="n">tcp</span>             <span class="n">web</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="mi">80</span>
<span class="n">mongo</span><span class="p">:</span><span class="mf">4.0</span><span class="o">.</span><span class="n">onths</span>         <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">27017</span><span class="o">-&gt;</span><span class="mi">27017</span><span class="o">/</span><span class="n">tcp</span>                             <span class="n">mongo4</span><span class="o">-</span><span class="mi">27017</span>
<span class="n">redis</span><span class="p">:</span><span class="mi">4</span><span class="o">-</span><span class="n">alonths</span>         <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">6379</span><span class="o">-&gt;</span><span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>                               <span class="n">redis</span><span class="o">-</span><span class="mi">6379</span>
<span class="n">jkarlos</span><span class="o">/</span><span class="n">gionths</span>         <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">2222</span><span class="o">-&gt;</span><span class="mi">22</span><span class="o">/</span><span class="n">tcp</span>                     <span class="n">git</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">source</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">repos</span>
<span class="n">mysql</span><span class="p">:</span><span class="mf">5.7</span> <span class="n">eeks</span>          <span class="mi">33060</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5004</span><span class="o">-&gt;</span><span class="mi">3306</span><span class="o">/</span><span class="n">tcp</span>                    <span class="n">mysql57</span><span class="o">-</span><span class="mi">5004</span>

<span class="n">rabbitmq</span><span class="p">:</span><span class="mi">3</span><span class="n">onths</span>         <span class="mi">4369</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5672</span><span class="o">-&gt;</span><span class="mi">5672</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">5671</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">25672</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">15672</span><span class="o">-&gt;</span><span class="mi">15672</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">rabbit5672</span>
</pre></div>
</div>
<div class="section" id="id4">
<h3>要点<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. 在内存不够的情况下，需要开启swap
2. django app映射到不同的本机外部端口，可以是80, 81等，也可以是8000, 8001等
3. nginx解析域名，指向不同的端口
4. redis，mongo，mysql，等都可以开多个实例，映射到不同端口即可
5. 线上生产系统不要把redis/mysql等端口开放到公网ip，应该仅限于内网访问
</pre></div>
</div>
</div>
<div class="section" id="nginx">
<h3>nginx<a class="headerlink" href="#nginx" title="永久链接至标题">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>确定服务端口，通常情况下监听80和443端口即可，支持http和https
nginx官方镜像的文件目录是/usr/share/nginx/html，将自已的文件目录mount到该目录即可
nginx官方镜像的配置文件目录是/etc/nginx/conf.d，将自已的配置文件目录mount到该目录
对于个人开发测试等用途，没有镜像分发需求，直接docker run起container即可

docker run                                                                      \
        --name web-nginx-80                                                     \
        -v /root/docker-op/nginx-test/content:/usr/share/nginx/html             \
        -v /root/docker-op/nginx-test/conf:/etc/nginx/conf.d                    \
        -d                                                                      \
        -p 0.0.0.0:80:80                                                        \
        -p 0.0.0.0:443:443                                                      \
        nginx:1.14.2-alpine
</pre></div>
</div>
<p>支持多站点的配置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>在前面提到的nginx配置文件夹中，针对每个site写一个配置文件，每增加一个site，简单增加一个配置文件即可
例如有以下5个配置文件，每个配置文件都支持了一个域名/子域名的web服务
当你要取消某个站点的服务时，简单的将名字改掉或删掉对应的配置文件即可
web-82.conf							# 一个应用跑在本机的82端口上，nginx转发相应的请求到该端口
webhook-8001.conf  			# 另一个叫做webhook的应用配置跑在本机的 8001端口，ningx将对应的请求转发到该端口
wx-web-81.conf					# 一个跑在 81端口上的微信公众号服务
not_use_web-84      		# 一个不再使用的配置文件
</pre></div>
</div>
<p>配置文件示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># this is a testing config for site: http://demo.hhxx.me
# copy this config to container:/etc/nginx/conf.d

  server {
    client_max_body_size 20M;
    listen       80;
    server_name  83.hhxx.me demo.hhxx.me;
    charset utf-8,gbk;
    access_log  /var/log/nginx/access.log  main;

    # pass requests for dynamic content to rails/turbogears/zope, et al
    location / {
#       return 200 &#39;web-83&#39;;
#       default_type &quot;text/html; charset=UTF-8&quot;;
      proxy_pass      http://10.0.0.13:83/;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For &quot;$http_x_forwarded_for, $realip_remote_addr&quot;;
      proxy_set_header Host $host;

    }
  }

# 注意这个配置是将请求转发到本机的83端口，因为一个docker封装的python/django应用被映射到83端口
# 其中 return 200 &#39;web-83&#39; 和 default_type，可用于测试nginx是否正确提供了期望的服务
</pre></div>
</div>
</div>
<div class="section" id="python3-django">
<h3>python3/Django应用<a class="headerlink" href="#python3-django" title="永久链接至标题">¶</a></h3>
<p>对于python/django应用，官方镜像默认源文件位于/usr/src/app目录</p>
<p>将自已的程序源文件目录mount到该目录即可</p>
<p>这里的PIP_CONF是为了解决python包下载速度太慢，配置了国内的镜像源</p>
<p>按照自已的喜好，可选阿里云或腾讯云的镜像源都可以。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># create a docker container named : pydev_

SOURCE_CODE_DIR=/root/docker-op/py_dev/code_repos/github_fei/fei
ENV_FILE_FILE=/root/docker-op/py_dev/code_repos/github_fei_env/env_fei
PIP_CONF=/root/docker-op/py_dev/pip-conf

docker run                                                                      \
        --name  83dj_fei                                                        \
        --env-file ${ENV_FILE_FILE}                                             \
        -v ${SOURCE_CODE_DIR}:/usr/src/app                                      \
        -v ${PIP_CONF}:/root/.pip                                               \
        -dit                                                                    \
        -p 0.0.0.0:83:8000                                                      \
        -p 0.0.0.0:5553:5556                                                    \
        python:3.6-stretch                                                      \
        sh -c &quot;cd /usr/src/app &amp;&amp;  pip install --no-cache-dir --default-timeout=150 -r  requirements.txt &amp;&amp;  python manage.py runserver 0.0.0.0:8000 --insecure &quot;

</pre></div>
</div>
</div>
<div class="section" id="mysql">
<h3>mysql<a class="headerlink" href="#mysql" title="永久链接至标题">¶</a></h3>
<p>对于mysql官方镜像源，默认的data dir是 /var/lib/mysql，默认的配置目录是 /etc/mysql/conf.d</p>
<p>将自已的数据目录和配置目录写好就可以了</p>
<p>mysql的端口如果开放公网访问的话（个人测试或开发一般会这么干），考虑把端口号改成 3306以外的端口，减少被扫描爆破的风险。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>MYSQL_DATA_DIR=&quot;/root/docker-op/mysql57/data_mysql57_5004&quot;
MYSQL_CONF_DIR=&quot;/root/docker-op/mysql57/conf.d&quot;
docker run --name mysql57-5004                                                          \
                -e MYSQL_ROOT_PASSWORD=Vpassword123456789 -d                            \
                -v $MYSQL_DATA_DIR:/var/lib/mysql                                       \
                -v $MYSQL_CONF_DIR:/etc/mysql/conf.d                     								\
                -p 0.0.0.0:3456:3306                                                    \
                mysql:5.7
</pre></div>
</div>
</div>
<div class="section" id="redis">
<h3>redis<a class="headerlink" href="#redis" title="永久链接至标题">¶</a></h3>
<p>redis的配置和上面差不多，都是了解下配置文件目录，然后就可以写好相应的脚本了。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CONTAINER_NAME=&quot;redis-6379&quot;

docker run                                                                              \
        -v ${REDIS_CONF_FILE}:/usr/local/etc/redis/redis.conf                           \
        -d                                                                              \
        -p 0.0.0.0:6379:6379                                                            \
        --name ${CONTAINER_NAME}                                                        \
        redis:4-alpine                                                                  \
        redis-server /usr/local/etc/redis/redis.conf
</pre></div>
</div>
</div>
<div class="section" id="rabbitmq">
<h3>rabbitmq<a class="headerlink" href="#rabbitmq" title="永久链接至标题">¶</a></h3>
<p>rabbitmq也一样，就是注意开放管理端口的话，需要再映射多一个管理端口</p>
<p>这里也是可以把默认端口改成其它端口。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This will start a RabbitMQ container listening on the default port of 5672.</span>

<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">hostname</span> <span class="n">my</span><span class="o">-</span><span class="n">rabbit</span>                      \
        <span class="o">-</span><span class="n">p</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5672</span><span class="p">:</span><span class="mi">5672</span>                            \
        <span class="o">-</span><span class="n">p</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">15672</span><span class="p">:</span><span class="mi">15672</span>                          \
        <span class="o">--</span><span class="n">name</span> <span class="n">rabbit5672</span> <span class="n">rabbitmq</span><span class="p">:</span><span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="git-server">
<h2>自建git server<a class="headerlink" href="#git-server" title="永久链接至标题">¶</a></h2>
<p>git server官方没有镜像，可以找其它人制作的镜像，也可以自已自制一个。</p>
<p>git server本身没啥特别的，一般碰到麻烦的无非就是配ssh/sshd的时候出状况。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 这里我用了一个别人自制的镜像 jkarlos/git-server-docker
HOST_REPO_DIR=&quot;/home/data/source-code-repos&quot;
CONTAINER_DIR=&quot;/home/git/source_code&quot;

SSH_KEYS_DIR=&quot;/root/docker-op/git-server/ssh_keys&quot;
CONTAINER_SSH_KEYS_DIR=&quot;/home/git/.ssh&quot;

docker run -d                                                                   \
        --name git-server-source-code-repos                                     \
        -p 2222:22                                                              \
        -v ${HOST_REPO_DIR}:${CONTAINER_DIR}                                    \
        -v ${SSH_KEYS_DIR}:${CONTAINER_SSH_KEYS_DIR}                            \
        jkarlos/git-server-docker
</pre></div>
</div>
<p><strong>docker很方便，也需要注意一些地方：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>可以为container设定--restart=always
google云服务器上预装的docker，设定是自动更新，如果container没有自动 restart，那么每次docker更新之后你就会奇怪为什么container都挂掉了！
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>腾讯云redis的一个简单测试<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>三个redis</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. 1C1G ECS上，docker 里运行的redis实例（本机）		（成都一区内网一）
2. 1C1G redis实例，腾讯云上的redis实例						（成都二区内网二）
3. 4C8G ECS上，docker 里运行的redis实例						（成都一区内网一）
即三个实例，其中1和3在同地同区同一内网，2在同地同区另一内网
</pre></div>
</div>
<p><strong>测试结果</strong>
实例 1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="c1"># 本机</span>
        <span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.13</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.051</span> <span class="n">ms</span>
        <span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.13</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.047</span> <span class="n">ms</span>
        <span class="n">start</span> <span class="n">bench</span> <span class="n">redis1</span>
        <span class="n">Duration</span><span class="p">:</span> <span class="mf">5.584269046783447</span>
</pre></div>
</div>
<p>实例 2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="c1"># 同地址域不同区的一个redis实例</span>
        <span class="c1"># redis-cli --latency -h 10.0.2.4 -p 6379</span>
        <span class="c1"># min: 1, max: 7, avg: 1.56 (343 samples)^C</span>
        <span class="c1"># 这个延迟达到1.56，也是相当的高；不过和两台同子网内的延迟比起来，似乎又不算历害了</span>
        <span class="n">start</span> <span class="n">bench</span> <span class="n">redis2金</span>
        <span class="n">Duration</span><span class="p">:</span> <span class="mf">52.816078186035156</span>
</pre></div>
</div>
<p>实例 3</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="c1"># 同区（成都一区）内同子网的另一台主机</span>
        <span class="c1"># 64 bytes from 10.0.0.22: icmp_seq=3 ttl=63 time=1.76 ms</span>
        <span class="c1"># 64 bytes from 10.0.0.22: icmp_seq=4 ttl=63 time=1.72 ms</span>
        <span class="c1"># 同子网内，这个延迟高的有点离谱</span>
        <span class="n">start</span> <span class="n">bench</span> <span class="n">redis3</span>
        <span class="n">Duration</span><span class="p">:</span> <span class="mf">57.26516246795654</span>
</pre></div>
</div>
<p>有点出乎意料的结果：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    仅从set来看，这个内网延迟很有点高；这么高的延迟，get都不用测了
    对于redis，连接池看来还是很有必要的，随便延迟高一点的话，完全发挥不出来它的优势
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api/modules.html" class="btn btn-neutral float-right" title="fei" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="Welcome to Fei Django Demo’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Fei

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>